<?

//--------------------------------------------------------------------------------------------------
//	add a new reply to a forum thread
//--------------------------------------------------------------------------------------------------

	if ( (array_key_exists('action', $_POST) == true) 
	   && ($_POST['action'] == 'newThreadReply')
	   && (array_key_exists('thread', $_POST) == true)
	   && (dbRecordExists('forumthreads', $_POST['thread']) == true) ) {

		//------------------------------------------------------------------------------------------
		//	auth (TODO)
		//------------------------------------------------------------------------------------------
		if (authHas('forums', 'show', '') == false) { do403(); }		// check basic permissions
		require_once($installPath . 'modules/forums/models/forum.mod.php');

		//------------------------------------------------------------------------------------------
		//	add the reply
		//------------------------------------------------------------------------------------------
		$reply = new ForumReply();
		$reply->data['thread'] = $_POST['thread'];
		$reply->data['content'] = $_POST['content'];
		$reply->save();

		//------------------------------------------------------------------------------------------
		//	increment reply count on thread
		//------------------------------------------------------------------------------------------
		$thread = new ForumThread($reply->data['thread']);
		$thread->data['replies'] += 1;
		$thread->data['updated'] = mysql_datetime();
		$thread->save();

		//------------------------------------------------------------------------------------------
		//	increment reply count on forum
		//------------------------------------------------------------------------------------------
		$forum = new Forum($thread->data['forum']);
		$forum->data['replies'] += 1;
		$forum->save();

		//------------------------------------------------------------------------------------------
		//	send a notification to poster
		//------------------------------------------------------------------------------------------
		

		//------------------------------------------------------------------------------------------
		//	redirect back to thread
		//------------------------------------------------------------------------------------------
		do302('forums/showthread/' . $thread->data['recordAlias']);

	} else { do404(); }		

?>
