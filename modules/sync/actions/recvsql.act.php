<?

//-------------------------------------------------------------------------------------------------
//	recieve a SQL update from a peer
//-------------------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------------
	//	authorize
	//---------------------------------------------------------------------------------------------
	if (false == $sync->authenticate()) { $page->doXmlError('could not authenticate'); }

	//---------------------------------------------------------------------------------------------
	//	add to database
	//---------------------------------------------------------------------------------------------
	if (false == array_key_exists('detail', $_POST)) { $page->doXmlError('update not sent'); }
	if ('' == trim($_POST['detail'])) { $page->doXmlError('update is empty'); }
	
	$data = $sync->base64DecodeSql($_POST['detail']);

	$kapenta->logSync("table: " . $data['table'] . "\n");
	foreach($data['fields'] as $f => $v) { $kapenta->logSync("field: $f value: $v \n"); }

	$sync->dbSave($data['table'], $data['fields']);

	//---------------------------------------------------------------------------------------------
	//	pass on to peers
	//---------------------------------------------------------------------------------------------	
	$syncHeaders = $sync->getHeaders();
	$source = $syncHeaders['Sync-Source'];
	$sync->broadcastDbUpdate($source, $data['table'], $data['fields']);

	//---------------------------------------------------------------------------------------------
	//	done
	//---------------------------------------------------------------------------------------------		
	echo "<ok/>"; flush();

?>
